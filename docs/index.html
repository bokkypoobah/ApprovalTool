<!DOCTYPE html>
<html lang="en">
  <head>
    <title>approvalTool</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="approvalTool (c) Bok Consulting Pty Ltd 2023" />
    <meta name="author" content="BokkyPooBah" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@BokkyPooBah" />
    <meta name="twitter:creator" content="@BokkyPooBah" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/app.css" />
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <script src="js/moment.min.js"></script>
    <script src="globals.js"></script>
    <script src="customNames.js"></script>
    <script src="deploymentData.js"></script>
    <!-- <script src="txInfo.js"></script> -->

    <link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-0">
        <b-navbar toggleable="sm" variant="light" class="mx-1 my-0 p-0">
          <b-navbar-brand to="/" variant="primary">
            <b-avatar rounded variant="light" size="3.0rem" src="images/ZombieBaby_004_zoomed.png" v-b-popover.hover.bottom="'gm'" class="ml-0"></b-avatar>
            <em v-b-popover.hover.bottom="'gm gm gm'">approvalTool</em>
          </b-navbar-brand>
          <b-navbar-nav class="ml-auto">
            <b-nav-item size="sm" @click="settings.tabIndex = 0; saveSettings();" :active="settings.tabIndex == 0" active-class="active" v-b-popover.hover="'Approvals'">Approvals</b-nav-item>
            <b-nav-item size="sm" @click="settings.tabIndex = 1; saveSettings();" :active="settings.tabIndex == 1" active-class="active" v-b-popover.hover="'Events'">Events</b-nav-item>
            <!-- <b-nav-item size="sm" @click="settings.tabIndex = 2; saveSettings();" :active="settings.tabIndex == 2" active-class="active" v-b-popover.hover="'Accounts'">Accounts</b-nav-item> -->
            <b-avatar v-if="coinbase && coinbase != nameOrAddress(coinbase)" rounded variant="light" size="3.0rem" :src="'https://metadata.ens.domains/mainnet/avatar/' + nameOrAddress(coinbase, 100)" v-b-popover.hover="'Your ENS avatar if set'"></b-avatar>
            <b-button size="sm" variant="outline-primary" class="ml-1" @click="connectToWeb3(); processNewBlock(0);" v-b-popover.hover.bottom="'Click to update wallet'">{{ coinbase ? nameOrAddress(coinbase, 16) : 'Connect' }}</b-button>
          </b-navbar-nav>
        </b-navbar>

        <b-card no-body class="p-0 mt-0" style="min-height: 666px;">
          <b-alert v-if="false" size="sm" dismissible variant="warning" show class="m-1 my-0">
            Warning: This is experimental unaudited software. Revoke permissions when not required, at this early stage.
          </b-alert>
          <b-card class="m-2 p-1" header-class="warningheader" header="Welcome" v-if="!coinbase || chainId != '1'">
            <b-card-text>
              Please install the MetaMask extension, connect to the Ethereum Mainnet and refresh this page. Then click the [Connect] button on the top right.
            </b-card-text>
          </b-card>

          <!-- :MODALAPPROVAL -->
          <b-modal id="modal-approval" hide-footer size="lg">
            <template #modal-title>
              View/Update {{ modalApproval.item.type.toUpperCase() }} {{ modalApproval.item.approvalType }}
            </template>
            <b-form-group v-if="modalApproval.item" label-cols-lg="2" label="Contract" label-size="md" label-class="font-weight-bold pt-0" class="mt-3 mb-0">
              <b-form-group v-if="modalApproval.item.contract" label="Address:" label-for="approval-address" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="link" id="approval-address" :href="'https://etherscan.io/address/' + modalApproval.item.contract + '#code'" v-b-popover.hover.bottom="'Click to view in etherscan.io'" target="_blank">{{ modalApproval.item.contract }}</b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.symbol" label="Symbol:" label-for="approval-symbol" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-symbol" :value="modalApproval.item.symbol" class="w-25"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.name" label="Name:" label-for="approval-name" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-name" :value="modalApproval.item.name" class="w-75"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type" label="Type:" label-for="approval-type" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-type" :value="modalApproval.item.type" class="w-25"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.decimals" label="Decimals:" label-for="approval-decimals" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-decimals" :value="modalApproval.item.decimals" class="w-25"></b-form-input>
              </b-form-group>
            </b-form-group>
            <b-form-group v-if="modalApproval.item" label-cols-lg="2" label="Approval" label-size="md" label-class="font-weight-bold pt-0" class="mt-3 mb-0">
              <b-form-group v-if="modalApproval.item.approvalType" label="Type:" label-for="approval-type" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-type" :value="modalApproval.item.approvalType" class="w-25"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.owner" label="Owner:" label-for="approval-owner" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="link" id="approval-owner" :href="'https://etherscan.io/address/' + modalApproval.item.owner" v-b-popover.hover.bottom="'Click to view in etherscan.io'" target="_blank">{{ nameOrAddress(modalApproval.item.owner, 42) }}</b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.spender" label="Spender:" label-for="approval-spender" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="link" id="approval-spender" :href="'https://etherscan.io/address/' + modalApproval.item.spender" v-b-popover.hover.bottom="'Click to view in etherscan.io'" target="_blank">{{ nameOrAddress(modalApproval.item.spender, 42) }}</b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type == 'erc20'" label="Tokens:" label-for="approval-tokens" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-tokens" :value="modalApproval.item.value" class="w-100"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type == 'erc721' && modalApproval.item.approvalType == 'Approval'" label="Token Id:" label-for="approval-tokenid" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-tokenid" :value="modalApproval.item.value" class="w-50"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.approvalType == 'ApprovalForAll'" label="Approved:" label-for="approval-approved" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" readonly id="approval-approved" :value="modalApproval.item.value == 1 ? 'true' : 'false'" class="w-25"></b-form-input>
              </b-form-group>
            </b-form-group>
            <b-form-group v-if="modalApproval.item" label-cols-lg="2" label="Update" label-size="md" label-class="font-weight-bold pt-0" class="mt-3 mb-0">
              <b-form-group v-if="modalApproval.item.type == 'erc20'" label="Tokens:" label-for="approval-update-tokens" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" id="approval-update-tokens" v-model="modalApproval.tokens" class="w-100" :placeholder="'Number with ' + modalApproval.item.decimals + ' decimal places, e.g., 0'"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type == 'erc721' && modalApproval.item.approvalType == 'Approval'" label="Spender:" label-for="approval-update-spender" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" id="approval-update-spender" v-model="modalApproval.spender" class="w-75" placeholder="Spender, e.g., 0x1234...6789"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type == 'erc721' && modalApproval.item.approvalType == 'Approval'" label="Token Id:" label-for="approval-update-tokenid" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-input type="text" size="sm" id="approval-update-tokenid" v-model="modalApproval.tokenId" class="w-50" placeholder="Token Id, e.g., 1234"></b-form-input>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.approvalType == 'ApprovalForAll'" label="Approved:" label-for="approval-update-approved" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-form-select size="sm" id="approval-update-approved" v-model="modalApproval.approved" :options="falseTrueOptions" class="w-25"></b-form-select>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type == 'erc20'" label="" label-for="approval-update-submit1" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-button size="sm" :disabled="!modalApproval.tokens" id="approval-update-submit1" @click="updateApproval()" variant="warning">Update</b-button>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.type == 'erc721' && modalApproval.item.approvalType == 'Approval'" label="" label-for="approval-update-submit2" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-button size="sm" :disabled="!modalApproval.spender || !modalApproval.tokenId" id="approval-update-submit2" @click="updateApproval()" variant="warning">Update</b-button>
              </b-form-group>
              <b-form-group v-if="modalApproval.item.approvalType == 'ApprovalForAll'" label="" label-for="approval-update-submit3" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <b-button size="sm" id="approval-update-submit3" @click="updateApproval()" variant="warning">Update</b-button>
              </b-form-group>
            </b-form-group>
          </b-modal>

          <!-- :MODALTX -->
          <!-- <b-modal id="modal-tx" hide-footer size="xl">
            <template #modal-title>
              <font size="-1">Tx {{ modalTx.txHash }}</font>
            </template>
            <b-form-group label-cols-lg="2" label="Tx" label-size="md" label-class="font-weight-bold pt-0" class="mt-3 mb-0">
              <b-form-group label="Hash:" label-for="tx-txhash" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="link" id="tx-txhash" :href="'https://etherscan.io/tx/' + modalTx.txHash" v-b-popover.hover.bottom="'Click to view in etherscan.io'" target="_blank">{{ modalTx.txHash }}</b-button>
                  <b-button size="sm" @click="copyToClipboard(modalTx.txHash);" variant="link" class="m-0 p-0" v-b-popover.hover.top="'Copy to clipboard'"><b-icon-clipboard shift-v="+1" font-scale="1.1"></b-icon-clipboard></b-button>
                </font>
              </b-form-group>
              <b-form-group label="At:" label-for="tx-timestamp" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button v-if="modalTx.timestamp" size="sm" variant="invisible" id="tx-timestamp"> {{ formatTimestamp(modalTx.timestamp) }}</b-button>
                  <b-button v-if="modalTx.tx && modalTx.tx.blockNumber" size="sm" variant="link" id="tx-blocknumber" :href="'https://etherscan.io/block/' + modalTx.tx.blockNumber" v-b-popover.hover.bottom="'Click to view block in etherscan.io'" target="_blank">{{ commify0(modalTx.tx.blockNumber) }}</b-button>
                  <b-button v-if="modalTx.tx && modalTx.tx.blockNumber" size="sm" @click="copyToClipboard(modalTx.tx.blockNumber);" variant="link" class="m-0 p-0" v-b-popover.hover.top="'Copy to clipboard'"><b-icon-clipboard shift-v="+1" font-scale="1.1"></b-icon-clipboard></b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.tx && modalTx.tx.from" label="From:" label-for="tx-from" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="link" id="tx-from" :href="'https://etherscan.io/address/' + modalTx.tx.from" v-b-popover.hover.bottom="'Click to view in etherscan.io'" target="_blank">{{ nameOrAddress(modalTx.tx.from, 42) }}</b-button>
                  <b-button size="sm" @click="copyToClipboard(modalTx.tx.from);" variant="link" class="m-0 p-0" v-b-popover.hover.top="'Copy to clipboard'"><b-icon-clipboard shift-v="+1" font-scale="1.1"></b-icon-clipboard></b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.tx && modalTx.tx.to" label="To:" label-for="tx-to" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="link" id="tx-to" :href="'https://etherscan.io/address/' + modalTx.tx.to" v-b-popover.hover.bottom="'Click to view in etherscan.io'" target="_blank">{{ nameOrAddress(modalTx.tx.to, 42) }}</b-button>
                  <b-button size="sm" @click="copyToClipboard(modalTx.tx.to);" variant="link" class="m-0 p-0" v-b-popover.hover.top="'Copy to clipboard'"><b-icon-clipboard shift-v="+1" font-scale="1.1"></b-icon-clipboard></b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.functionCall" label="Function Call:" label-for="tx-functioncall" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="invisible" id="tx-functioncall">{{ modalTx.functionCall.name }}</b-button>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.functionCall" label="" label-for="tx-functioncallparameters" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-2">
                  <b-table small fixed striped :fields="functionCallParametersFields" :items="modalTx.functionCall.parameters" head-variant="light">
                    <template #cell(value)="data">
                      <span v-if="data.item.type == 'address'">
                        <b-link :href="'https://etherscan.io/address/' + data.item.value" v-b-popover.hover.bottom="'View in etherscan.io'" target="_blank">
                          {{ nameOrAddress(data.item.value, 42) }}
                        </b-link>
                      </span>
                      <span v-else-if="['minSalePriceInWei'].includes(data.item.parameter)">
                        {{ formatETH(data.item.value, 0) }} <font size="-2">Îž</font>
                      </span>
                      <span v-else>
                        <b-badge pill variant="invisible" v-b-popover.hover.bottom="data.item.value">{{ data.item.value.substring(0, 42) + (data.item.value.length > 42 ? '...' : '') }}</b-badge>
                      </span>
                    </template>
                  </b-table>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.tx && modalTx.tx.value" label="Value:" label-for="tx-value" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="invisible" id="tx-value">{{ formatETH(modalTx.tx.value, 0) }}</b-button><font size="-2">Îž, {{ settings.reportingCurrency }} {{ commify2(modalTx.valueInReportingCurrency) }} @ {{ modalTx.exchangeRate }}</font>
                </font>
              </b-form-group>
              <b-form-group label="Gas:" label-for="tx-gasused" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button v-if="modalTx.txReceipt && modalTx.txReceipt.gasUsed" size="sm" variant="invisible" id="tx-gasused" v-b-popover.hover.bottom="'Gas used'">{{ commify0(modalTx.txReceipt.gasUsed) }}</b-button>
                  <font size="-2">
                    /
                  </font>
                  <b-button v-if="modalTx.tx && modalTx.tx.gasLimit" size="sm" variant="invisible" id="tx-gaslimit" v-b-popover.hover.bottom="'Gas limit'">{{ commify0(modalTx.tx.gasLimit) }}</b-button>
                  <font v-if="modalTx.txReceipt && modalTx.txReceipt.gasUsed && modalTx.tx && modalTx.tx.gasLimit" size="-2">
                    {{ (modalTx.txReceipt.gasUsed/modalTx.tx.gasLimit*100).toFixed(0) + '%' }}
                  </font>
                  <font v-if="modalTx.txReceipt && modalTx.txReceipt.effectiveGasPrice" size="-2">
                    {{ '@ ' + formatGas(modalTx.txReceipt.effectiveGasPrice, 2) + ' gwei' }}
                  </font>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.txFee" label="Tx Fee:" label-for="tx-txfee" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-1">
                  <b-button size="sm" variant="invisible" id="tx-txfee">{{ formatETH(modalTx.txFee, 0) }}</b-button><font size="-2">Îž, {{ settings.reportingCurrency }} {{ commify2(modalTx.txFeeInReportingCurrency) }} @ {{ modalTx.exchangeRate }}</font>
                </font>
              </b-form-group>
              <b-form-group v-if="modalTx.logs" label="Events:" label-for="tx-eventlogs" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
                <font size="-2">
                  <b-table small fixed striped :fields="eventLogFields" :items="modalTx.logs" head-variant="light">
                    <template #cell(contract)="data">
                      <b-link :href="'https://etherscan.io/address/' + data.item.contract" v-b-popover.hover.bottom="'View in etherscan.io'" target="_blank">
                        {{ nameOrAddress(data.item.contract, 42) }}
                      </b-link>
                    </template>
                    <template #cell(fields)="data">
                      <span v-for="(field, index) of data.item.fields">
                        <span v-if="field.type == 'address'" class="m-0 p-0">
                          {{ field.field + '=' }}
                          <b-link :href="'https://etherscan.io/address/' + field.value" v-b-popover.hover.bottom="'View in etherscan.io'" target="_blank">
                            <b-badge pill variant="invisible">{{ nameOrAddress(field.value, 42) + '...' }}</b-badge>
                          </b-link>
                        </span>
                        <span v-else class="m-0 p-0">
                          {{ field.field + '=' }}
                          <b-badge pill variant="invisible" v-b-popover.hover.bottom="field.value.toString()">{{ field.value.toString().substring(0, 42) + (field.value.toString().length > 42 ? '...' : '') }}</b-badge>
                        </span>
                        <span v-if="index != (data.item.fields - 1)">
                          ,
                        </span>
                      </span>

                    </template>
                  </b-table>
                </font>
              </b-form-group>
            </b-form-group>
            <pre>
{{ modalTx }}
            </pre>
          </b-modal> -->

          <b-card class="m-0 p-0 border-0" body-class="m-1 p-0">
            <!-- :TOOLBAR -->
            <b-card-text v-if="coinbase" class="m-0 p-0">
              <div class="d-flex flex-wrap m-0 p-0">
                <div v-if="false" class="mt-0">
                  <b-button size="sm" :pressed.sync="settings.showFilter" @click="saveSettings" variant="link" v-b-popover.hover.bottom="'Show filter'"><span v-if="settings.showFilter"><b-icon-layout-sidebar-inset shift-v="+1" font-scale="1.0"></b-icon-layout-sidebar-inset></span><span v-else><b-icon-layout-sidebar shift-v="+1" font-scale="1.0"></b-icon-layout-sidebar></span></b-button>
                </div>
                <div v-if="settings.tabIndex == 0" class="mt-1 pr-1">
                  <b-form-checkbox size="sm" v-model.trim="settings.approvalsTable.includeInactive" @input="saveSettings" v-b-popover.hover.bottom="'Include inactive approvals'">
                    Inactive
                  </b-form-checkbox>
                </div>
                <div v-if="settings.tabIndex == 1" class="mt-1 pr-1">
                  <b-form-checkbox size="sm" v-model.trim="settings.includeFluff" @input="saveSettings" v-b-popover.hover.bottom="'Include unimportant events like ERC-721 Approval to Null:0x0000...0000'">
                    Fluff
                  </b-form-checkbox>
                </div>
                <div v-if="false" class="mt-0 pr-1" style="max-width: 11.0rem;">
                  <b-form-input type="text" size="sm" v-model.trim="settings.filterByIds" @change="saveSettings" debounce="600" v-b-popover.hover.bottom="'Filter by punk id(s) or first 3 (or more) characters of attribute names, e.g., `1 5-10 alien ape`. Replace spaces with `-`, e.g., `male-4`, `clown-nose` or `3d-gl`'" placeholder="ðŸ” id1 id2-id3 attrib1 ..."></b-form-input>
                </div>
                <div v-if="false" class="mt-0 pr-1" style="max-width: 11.0rem;">
                  <b-form-input type="text" size="sm" v-model.trim="settings.filterByOwners" @change="saveSettings" debounce="600" v-b-popover.hover.bottom="'Filter owner addresses and names by space separated regex. Some custom names `larvalabs`, `yugalabs`, `dead:`'" placeholder="ðŸ” 0x12ab... name1 ..."></b-form-input>
                </div>
                <div v-if="settings.tabIndex == 1001" class="mt-0 pr-1">
                  <b-form-checkbox-group size="sm" @input="saveSettings" v-model="settings.selectedContracts" :options="contractOptions" buttons button-variant="outline-primary" v-b-popover.hover.bottom="'Filter by [Wrapped] CryptoPunks V1 & V2'"></b-form-checkbox-group>
                </div>
                <div v-if="Object.keys(settings.filters).length > 0 || settings.filterByIds || settings.filterByOwners" class="mt-0 pr-1">
                  <b-button size="sm" @click="resetFilters();" variant="link" class="m-0 p-0" v-b-popover.hover.bottom="'Reset filters'">
                    <b-iconstack shift-v="-4" font-scale="1">
                      <b-icon stacked icon="funnel-fill" variant="info" scale="1"></b-icon>
                      <b-icon stacked icon="x" variant="danger" scale="1.3"></b-icon>
                    </b-iconstack>
                  </b-button>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
                <div v-if="!sync.section" class="mt-0 pr-1">
                  <b-button size="sm" @click="checkIt(false)" variant="primary" v-b-popover.hover.bottom="'Check approvals'">Check</b-button>
                </div>
                <div v-if="!sync.section" class="mt-0 pr-1">
                  <b-button size="sm" @click="checkIt(true)" variant="outline-primary" v-b-popover.hover.bottom="'This will do dev things'">Dev</b-button>
                </div>
                <div v-if="sync.section" class="mt-1 p-0" style="width: 350px;">
                  <b-progress height="1.5rem" :max="sync.total" show-progress :animated="!sync.section" :variant="sync.section ? 'success' : 'secondary'" v-b-popover.hover.bottom="'{processed blocked number}/{latest block number}. Click the button on the right to stop this process. This process can be continued later'">
                    <b-progress-bar :value="sync.completed">
                      {{ sync.total == null || sync.total == 0 ? (sync.completed + ' ' + sync.section) : (sync.completed + '/' + sync.total + ' ' + ((sync.completed / sync.total) * 100).toFixed(0) + '% ' + sync.section) }}
                    </b-progress-bar>
                  </b-progress>
                </div>
                <div class="ml-0 mt-1">
                  <b-link v-if="sync.section" size="sm" @click="halt" variant="link" v-b-popover.hover.bottom="'Click to stop. It may take a few minutes to clean up. This process can be continued later'"><b-icon-stop-fill shift-v="+1" font-scale="1.0"></b-icon-stop-fill></b-link>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
                <div class="mt-0 pl-1">
                  <b-button size="sm" :pressed.sync="settings.showInfo" @click="saveSettings" variant="link" v-b-popover.hover.bottom="'Show info'"><span v-if="settings.showInfo"><b-icon-info-circle-fill shift-v="+1" font-scale="1.0"></b-icon-info-circle-fill></span><span v-else><b-icon-info-circle shift-v="+1" font-scale="1.0"></b-icon-info-circle></span></b-button>
                </div>
                <div class="mt-0 flex-grow-1">
                </div>
                <div v-if="settings.tabIndex == 1" class="mt-0 pl-1">
                  <b-form-select size="sm" v-model="settings.eventsTable.sortOption" @change="saveSettings" :options="eventsSortOptions" v-b-popover.hover.bottom="'Yeah. Sort'"></b-form-select>
                </div>
                <div v-if="settings.tabIndex == 110" class="mt-0 pl-1">
                  <font size="-2" v-b-popover.hover.bottom="'# events'">{{ filteredSortedEvents.length + '/' + Object.keys(txs).length }}</font>
                </div>
                <div v-if="settings.tabIndex == 111" class="mt-0 pl-1">
                  <font size="-2" v-b-popover.hover.bottom="'# events'">{{ events.length + '/' + totalEvents }}</font>
                </div>
                <div v-if="settings.tabIndex == 112 && totalEvents" class="mt-0 pl-1">
                  <font size="-2" v-b-popover.hover.bottom="'# events'">{{ commify0(totalEvents) }}</font>
                </div>
                <div v-if="settings.tabIndex == 0" class="mt-0 pl-1">
                  <font size="-2" v-b-popover.hover.bottom="'# approvals'">{{ commify0(filteredApprovals.length) + '/' + commify0(approvals.length) }}</font>
                </div>
                <div v-if="settings.tabIndex == 1" class="mt-0 pl-1">
                  <font size="-2" v-b-popover.hover.bottom="'# events'">{{ commify0(filteredEvents.length) + '/' + commify0(events.length) }}</font>
                </div>
                <div v-if="settings.tabIndex == 112 && blockNumber && timestamp" class="mt-0 pl-1">
                  <font size="-2" v-b-popover.hover.bottom="'latest block'">
                    <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="formatTimestamp(timestamp)" target="_blank">
                      {{ '#' + commify0(blockNumber) + ' ' + formatTimeDiff(timestamp) }}
                    </b-link>
                  </font>
                </div>
                <div v-if="settings.tabIndex == 0" class="mt-0 pl-1">
                  <b-pagination size="sm" v-model="settings.approvalsTable.currentPage" @input="saveSettings" :total-rows="filteredSortedApprovals.length" :per-page="settings.approvalsTable.pageSize" style="height: 0;"></b-pagination>
                </div>
                <div v-if="settings.tabIndex == 1" class="mt-0 pl-1">
                  <b-pagination size="sm" v-model="settings.eventsTable.currentPage" @input="saveSettings" :total-rows="filteredSortedEvents.length" :per-page="settings.eventsTable.pageSize" style="height: 0;"></b-pagination>
                </div>
                <div v-if="settings.tabIndex == 0" class="mt-0 pl-1">
                  <b-form-select size="sm" v-model="settings.approvalsTable.pageSize" @change="saveSettings();" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
                </div>
                <div v-if="settings.tabIndex == 1" class="mt-0 pl-1">
                  <b-form-select size="sm" v-model="settings.eventsTable.pageSize" @change="saveSettings();" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
                </div>
              </div>
            </b-card-text>

            <b-card-text class="m-0 p-0">
              <!-- :INFO -->
              <b-card v-if="settings.showInfo || coinbase == null" no-body class="my-1 p-1">
                <b-card-body class="mt-1 p-1">
                  <h4>Welcome</h4>
                  <b>approvalTool</b> is a lightweigh web3 dapp tool to manage your approvals for ERC-20, ERC-721 and ERC-1155 token contracts.

                  <!-- This dapp retrieves historical log events from the <b-link href="https://cryptopunks.app/" target="_blank">CryptoPunks</b-link> contracts on the Ethereum mainnet, collates the data, and provides an interface for users to query the data.
                  This dapp currently takes about 10 minutes to retrieve the data initially, and about a minute to sync subsequently. -->

                  <h5 class="mt-4">How This Works</h5>
                  <ul>
                    <li>This tool scans for <b-link href="https://eips.ethereum.org/EIPS/eip-20" target="_blank">ERC-20</b-link>, <b-link href="https://eips.ethereum.org/EIPS/eip-721" target="_blank">ERC-721</b-link> and <b-link href="https://eips.ethereum.org/EIPS/eip-1155" target="_blank">ERC-1155</b-link> <b>Approval</b> and <b>ApprovalForAll</b> log events from the owner's account. This is done using the <b>getFilter(...)</b> web3 call</li>
                    <li>These event logs are then processed to determine the approval states for the various ERC-20, ERC-721 and ERC-1155 contracts</li>
                    <li>This tool retrieves block timestamps from <b-link href="https://api.thegraph.com/subgraphs/name/blocklytics/ethereum-blocks" target="_blank">https://api.thegraph.com/subgraphs/name/blocklytics/ethereum-blocks</b-link></li>
                  </ul>

                  <h5 class="mt-3">Requirements</h5>
                  <ul>
                    <li>This dapp runs in web3 enabled desktop browsers connected to the Ethereum mainnet</li>
                  </ul>

                  <h5 class="mt-3">References</h5>
                  <ul>
                    <li>Dapp: <b-link href="https://bokkypoobah.github.io/ApprovalTool/" target="_blank">https://bokkypoobah.github.io/ApprovalTool/</b-link></li>
                    <li>GitHub: <b-link href="https://github.com/bokkypoobah/ApprovalTool" target="_blank">https://github.com/bokkypoobah/ApprovalTool</b-link></li>
                    <li>Main Dapp Source Code: <b-link href="https://github.com/bokkypoobah/ApprovalTool/blob/main/docs/index.html" target="_blank">https://github.com/bokkypoobah/ApprovalTool/blob/main/docs/index.html</b-link></li>
                  </ul>

                  <h5 class="mt-3">Running Locally</h5>
                  <ul>
                    <li>In a folder on your computer, <b>git clone <b-link href="https://github.com/bokkypoobah/ApprovalTool" target="_blank">https://github.com/bokkypoobah/ApprovalTool</b-link></b></li>
                    <li>Run a tool like <b-link href="https://www.npmjs.com/package/anywhere" target="_blank">anywhere</b-link> in the <b>./docs</b> subdirectory of the folder created above</li>
                  </ul>
                  <!-- <h5 class="mt-3">This Dapp Design</h5>
                  <ul>
                    <li>Addresses and transaction hashes are stored as integer indices into lookup tables to save on memory and computations</li>
                    <li>Arrays are used instead of Maps in some sections to save on memory and computations</li>
                    <li><b-link href="https://github.com/bokkypoobah/CryptoPunksData/tree/master/docs/images/punks" target="_blank">10k 24x24 punk images</b-link> were split from the original <b-link href="https://raw.githubusercontent.com/larvalabs/cryptopunks/master/punks.png" target="_blank">punks.png</b-link> using the <b-link href="https://github.com/bokkypoobah/aenus/blob/main/scripts/01_splitImage.js" target="_blank">01_splitImage.js</b-link> script</li>
                    <li><b-link href="https://raw.githubusercontent.com/bokkypoobah/CryptoPunksData/master/docs/punkAttributes.js" target="_blank">10k punk attributes</b-link> were extracted from the <i>CryptopunksData</i> contract at <b-link href="https://etherscan.io/address/0x16F5A35647D6F03D5D3da7b35409D65ba03aF3B2#code" target="_blank">0x16F5A35647D6F03D5D3da7b35409D65ba03aF3B2</b-link> using the <b-link href="https://github.com/bokkypoobah/aenus/blob/main/scripts/02_scrapeCryptoPunksAttributes.js" target="_blank">02_scrapeCryptoPunksAttributes.js</b-link> script</li>
                  </ul> -->
                  <!-- <h5 class="mt-3">Some Info</h5>
                  <ul>
                    <li>Three v1s were claimed with invalid ids <b-link href="https://etherscan.io/tx/0x39d77a95637640b6291bea0b015be4f6578c95f9a57af6a9399dabd70b56d50c" target="_blank">9845944</b-link>, <b-link href="https://etherscan.io/tx/0xdc37a82d43eb253077abd4618683efea615fc8573bfc669568fab04098ab24b1" target="_blank">76623</b-link> and <b-link href="https://etherscan.io/tx/0x7da83b5002251ca83537aef8833f443263a9109a1ccca502b0b03a0529813aa2" target="_blank">0xffff...ffff</b-link>. This resulted in 3 unassigned v1s 1416, 1838 and 1841</li>
                    <li>LarvaLabs airdropped these 3 unassigned v2s <b-link href="https://cryptopunks.app/cryptopunks/details/1416" target="_blank">1416</b-link>, <b-link href="https://cryptopunks.app/cryptopunks/details/1838" target="_blank">1838</b-link> and <b-link href="https://cryptopunks.app/cryptopunks/details/1841" target="_blank">1841</b-link> to <b-link href="https://etherscan.io/address/0x5b098b00621eda6a96b7a476220661ad265f083f" target="_blank">0x5b098b...</b-link></li>
                    <li>Two v2s <b-link href="https://etherscan.io/tx/0xce9bdec865497ba6d3c7e26bdfac54d4270285361a0f65ff09f042997b318b38" target="_blank">2838</b-link> and <b-link href="https://etherscan.io/tx/0x2c7a8584e8c3d5c14232881f2e7aef4cbacfe1cb729b67b129f84b0384018330" target="_blank">5449</b-link> have been incorrectly transferred to the v2 CryptoPunk contract</li>
                  </ul> -->
                  <h5 class="mt-3">Troubleshooting</h5>
                  <ul>
                    <li>If this dapp is not receiving the latest Mainnet data, reset your MetaMask web3 connection using <b>Settings</b> -> <b>Advanced</b> -> <b>Clear activity and nonce data</b></li>
                    <li>Reset this dapp data by removing LocalStorage entries with the keys beginning with <b>approval</b></li>
                  </ul>
                  <!-- <h5 class="mt-3">CryptoPunks History</h5>
                  <ul>
                    <li>The v1 contract was deployed to <b-link href="https://etherscan.io/address/0x6Ba6f2207e343923BA692e5Cae646Fb0F566DB8D#code" target="_blank">0x6Ba6f2207e343923BA692e5Cae646Fb0F566DB8D</b-link> at Jun-09-2017 12:22:50 AM +UTC</li>
                    <li><b-link href="https://www.reddit.com/r/ethereum/comments/6g8cma/cryptopunks_an_experiment_in_digital_collectibles/" target="_blank">CryptoPunks: An experiment in digital collectibles on Ethereum</b-link> announced on Reddit at Jun-09-2017 01:19:08 AM UTC</li>
                    <li>Due to a <b-link href="https://twitter.com/cryptopunksnfts/status/876106428200738816" target="_blank">bug in v1 contract</b-link>, <b-link href="https://twitter.com/cryptopunksnfts/status/878353034194984961" target="_blank">v2 was deployed</b-link> to <b-link href="https://etherscan.io/address/0xb47e3cd837dDF8e4c57F05d70Ab865de6e193BBB#code" target="_blank">0xb47e3cd837dDF8e4c57F05d70Ab865de6e193BBB</b-link> at Jun-22-2017 07:40:00 PM +UTC</li>
                    <li>The ERC-721 wrapper for the v2 contract was deployed to <b-link href="https://etherscan.io/address/0xb7F7F6C52F2e2fdb1963Eab30438024864c313F6#code" target="_blank">0xb7F7F6C52F2e2fdb1963Eab30438024864c313F6</b-link> at Sep-08-2020 03:11:25 PM +UTC</li>
                    <li>The ERC-721 wrapper for the v1 contract was deployed to <b-link href="https://etherscan.io/address/0x282BDD42f4eb70e7A9D9F40c8fEA0825B7f68C5D#code" target="_blank">0x282BDD42f4eb70e7A9D9F40c8fEA0825B7f68C5D</b-link> at Jan-17-2022 10:15:07 AM +UTC</li>
                  </ul> -->
                </b-card-body>
              </b-card>

              <b-table v-if="settings.tabIndex == 0 && !settings.showInfo" ref="approvalsTable" small fixed striped responsive hover selectable select-mode="single" @row-selected='approvalsRowSelected' :fields="approvalsFields" :items="pagedFilteredSortedApprovals" show-empty empty-html="Click Check above to retrieve ERC-20, ERC-721 and ERC-1155 Approval and ApprovalForAll events" head-variant="light" class="mx-0 my-1">
                <template #cell(number)="data">
                  <font size="-1">
                    {{ parseInt(data.index) + ((settings.approvalsTable.currentPage - 1) * settings.approvalsTable.pageSize) + 1 }}
                  </font>
                </template>
                <template #cell(type)="data">
                  <b-badge pill variant="transparent" class="px-0">{{ data.item.type }}</b-badge>
                </template>
                <template #cell(symbol)="data">
                  <b-badge pill variant="transparent" class="px-0">{{ data.item.symbol }}</b-badge>
                </template>
                <template #cell(name)="data">
                  <b-badge pill variant="transparent" class="px-0">{{ data.item.name }}</b-badge>
                </template>
                <template #cell(approvalType)="data">
                  <b-badge pill variant="transparent" class="px-0">{{ data.item.approvalType }}</b-badge>
                </template>
                <template #cell(owner)="data">
                  <b-link :href="'https://etherscan.io/address/' + data.item.owner" target="_blank">
                    <b-badge pill variant="transparent" v-b-popover.hover="addressDescription(data.item.owner)" class="px-0">{{ nameOrAddress(data.item.owner, 24) }}</b-badge>
                  </b-link>
                </template>
                <template #cell(spender)="data">
                  <b-link :href="'https://etherscan.io/address/' + data.item.spender" target="_blank">
                    <b-badge pill variant="transparent" v-b-popover.hover="addressDescription(data.item.spender)" class="px-0">{{ nameOrAddress(data.item.spender, 24) }}</b-badge>
                  </b-link>
                </template>
                <template #cell(approved)="data">
                  <!-- <b-link :href="'https://etherscan.io/address/' + data.item.spender" target="_blank">
                    <b-badge pill variant="transparent" v-b-popover.hover="addressDescription(data.item.spender)" class="px-0">{{ nameOrAddress(data.item.spender, 28) }}</b-badge>
                  </b-link> -->
                  <span v-if="data.item.type == 'erc20'">
                    <span v-if="data.item.value.toString().length > 30">
                      <b-badge pill variant="transparent" v-b-popover.hover="formatDecimals(data.item.value, data.item.decimals)" class="px-0">&infin;</b-badge>
                    </span>
                    <span v-else>
                      <b-badge pill variant="transparent" class="px-0">{{ formatDecimals(data.item.value, data.item.decimals) }}</b-badge>
                    </span>
                  </span>
                  <span v-else-if="data.item.approvalType == 'Approval'">
                    <b-link :href="'https://opensea.io/assets/ethereum/' + data.item.contract + '/' + data.item.value" target="_blank">
                      <b-badge pill variant="transparent" v-b-popover.hover="'View in opensea.io'" class="px-0">{{ '#' + commify0(data.item.value) }}</b-badge>
                    </b-link>
                  </span>
                  <span v-else>
                    <b-badge pill variant="transparent" class="px-0">{{ data.item.value ==  1 ? "true" : "false" }}</b-badge>
                  </span>
                </template>
              </b-table>

              <b-table v-if="settings.tabIndex == 1 && !settings.showInfo && events" small fixed striped responsive hover :fields="eventsFields" :items="pagedFilteredSortedEvents" show-empty empty-html="Click Check above to retrieve ERC-20, ERC-721 and ERC-1155 Approval and ApprovalForAll events" head-variant="light" class="mx-0 my-1">
                <template #cell(number)="data">
                  <font size="-1">
                    {{ parseInt(data.index) + ((settings.eventsTable.currentPage - 1) * settings.eventsTable.pageSize) + 1 }}
                  </font>
                </template>
                <template #cell(timestamp)="data">
                  <font size="-1">
                    <b-link :href="'https://etherscan.io/tx/' + data.item.txHash" v-b-popover.hover.bottom="'Block #' + commify0(data.item.blockNumber) + ', txIndex: ' + data.item.txIndex + ', logIndex: ' + data.item.logIndex" target="_blank">
                      {{ formatTimestamp(data.item.timestamp) }}
                    </b-link>
                    <!-- <br />
                    <font size="-1">
                      <b-badge pill variant="transparent" v-b-popover.hover="'Block Number'" class="px-0">{{ commify0(data.item.blockNumber) }}</b-badge>
                      <b-badge pill variant="transparent" v-b-popover.hover="'Transaction Index'" class="px-0">{{ data.item.txIndex }}</b-badge>
                      <b-badge pill variant="transparent" v-b-popover.hover="'Log Index'" class="px-0">{{ data.item.logIndex }}</b-badge>
                    </font> -->
                  </font>
                </template>
                <template #cell(owner)="data">
                  <b-link :href="'https://etherscan.io/address/' + data.item.owner" target="_blank">
                    <b-badge pill variant="transparent" v-b-popover.hover="addressDescription(data.item.owner)" class="px-0">{{ nameOrAddress(data.item.owner, 28) }}</b-badge>
                  </b-link>
                </template>
                <template #cell(type)="data">
                  <b-badge pill variant="transparent" class="px-0">{{ data.item.type }}</b-badge>
                </template>
                <template #cell(contract)="data">
                  <b-link :href="'https://etherscan.io/address/' + data.item.contract" target="_blank">
                    <b-badge pill variant="transparent" v-b-popover.hover="addressDescription(data.item.contract)" class="px-0">{{ nameOrAddress(data.item.contract, 28) }}</b-badge>
                  </b-link>
                </template>
                <template #cell(eventName)="data">
                  <b-badge pill variant="transparent" class="px-0">{{ data.item.eventName }}</b-badge>
                </template>
                <template #cell(spender)="data">
                  <b-link :href="'https://etherscan.io/address/' + data.item.spender" target="_blank">
                    <b-badge pill variant="transparent" v-b-popover.hover="addressDescription(data.item.spender)" class="px-0">{{ nameOrAddress(data.item.spender, 28) }}</b-badge>
                  </b-link>
                </template>
                <template #cell(approved)="data">
                  <!-- {{ data.item }} -->
                  <span v-if="data.item.type == 'erc20'">
                    <span v-if="data.item.value.toString().length > 30">
                      <b-badge pill variant="transparent" v-b-popover.hover="formatDecimals(data.item.value, data.item.decimals)" class="px-0">&infin;</b-badge>
                    </span>
                    <span v-else>
                      <b-badge pill variant="transparent" class="px-0">{{ formatDecimals(data.item.value, data.item.decimals) }}</b-badge>
                    </span>
                  </span>
                  <span v-else-if="data.item.eventName == 'Approval'">
                    <b-link :href="'https://opensea.io/assets/ethereum/' + data.item.contract + '/' + data.item.value" target="_blank">
                      <b-badge pill variant="transparent" v-b-popover.hover="'View in opensea.io'" class="px-0">{{ '#' + commify0(data.item.value) }}</b-badge>
                    </b-link>
                  </span>
                  <span v-else>
                    <b-badge pill variant="transparent" class="px-0">{{ data.item.value ? "true" : "false" }}</b-badge>
                  </span>
                </template>
              </b-table>

              <b-card-text v-if="settings.tabIndex == 2 && !settings.showInfo" class="mt-5">
                Work in progress. See <b-link size="sm" @click="settings.tabIndex = 1; saveSettings();" v-b-popover.hover="'Events'">Events</b-link>
              </b-card-text>

              <b-row v-if="false" class="m-0 p-0">
                <b-col class="m-0 p-0">
                  <!-- :EVENTS -->
                  <!-- <b-table v-if="settings.tabIndex == 1 && !settings.showInfo" small fixed striped responsive hover :fields="eventsFields" :items="events" show-empty empty-html="Click Sync above to retrieve contract events" head-variant="light" class="mx-0 my-1"> -->
                  <b-table v-if="settings.tabIndex == 1 && !settings.showInfo" small fixed striped responsive hover :items="events" show-empty empty-html="Click Sync above to retrieve contract events" head-variant="light" class="mx-0 my-1">
                    <template #cell(number)="data">
                      {{ parseInt(data.index) + ((settings.activityTable.currentPage - 1) * settings.activityTable.pageSize) + 1 }}
                    </template>
                  </b-table>

                </b-col>
              </b-row>
            </b-card-text>
          </b-card>
        </b-card>

        <b-card no-header body-class="m-0 p-0" class="m-0 p-0 border-0">
          <div class="d-flex flex-wrap m-0 p-0">
            <div class="ml-0 mt-1 pl-1">
              <font v-if="connected" size="-2">
                <!-- <b-link v-if="coinbase" :href="'https://etherscan.io/address/' + coinbase" v-b-popover.hover.bottom="'Coinbase'" target="_blank">
                  {{ coinbase.substring(0, 10) }}
                </b-link> -->
                <b-link v-if="chainId" :href="'https://etherscan.io/'" v-b-popover.hover.bottom="'Network'" target="_blank">
                  {{ chainId == '1' ? 'Mainnet' : 'Unsupported' }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="'Latest block'" target="_blank">
                  {{ '#' + commify0(blockNumber) }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="formatTimestamp(timestamp)" target="_blank">
                  {{ formatTimeDiff(timestamp) }}
                </b-link>
              </font>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1 pr-1">
              gm, and enjoy! <i>approvalTool</i> &copy; Bok Consulting Pty Ltd 2023
            </div>
          </div>
        </b-card>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        // --- DATA ---
        data: {
          connected: false,
          chainId: null,
          coinbase: null,
          blockNumber: null,
          timestamp: null,

          settings: {
            tabIndex: 0,
            showFilter: false,
            showInfo: false,
            filterByIds: null,
            filterByOwners: null,
            filters: {},
            selectedContracts: [],
            reportingDateTime: 0,
            includeFluff: true,
            approvalsTable: {
              filter: null,
              includeInactive: false,
              currentPage: 1,
              pageSize: 100,
              sortOption: 'symbolasc',
            },
            eventsTable: {
              filter: null,
              currentPage: 1,
              pageSize: 100,
              sortOption: 'txorderdsc',
            },
            accountsTable: {
              filter: null,
              currentPage: 1,
              pageSize: 100,
              sortOption: 'symbolasc',
            },
            version: 7,
          },
          sync: {
            section: null,
            total: null,
            completed: null,
            halt: false,
          },
          events: [],
          accounts: {},

          syncStates: {},
          blockTimestamps: {},
          exchangeRates: {},
          addressToIndex: {},
          indexToAddress: [],
          txHashToIndex: {},
          indexToTxHash: [],
          indexToAddressName: {},

          indexToString: [],
          stringToIndex: {},

          indexToNameLabel: [],
          nameToIndex: {},
          labelToIndex: {},

          indexToHash: [],
          hashToIndex: {},
          txs: [],
          tokens: {},
          offers: { "1": {}, "2": {} },
          v2Bids: {},

          modalApproval: {
            item: null,
            tokens: null, // ERC-20 Approval
            spender: null, // ERC-721 Approval
            tokenId: null, // ERC-721 Approval
            approved: false, // ERC-721 & ERC-1155 ApprovalForAll
          },

          modalPunk: {
            punkId: null,
            v1: {
              ownerIndex: null,
              wrapped: false,
            },
            v2: {
              ownerIndex: null,
              wrapped: false,
            },
            attributes: {},
          },
          modalAddress: {
            addressIndex: null,
            address: null,
            name: null,
          },
          // modalTx: {
          //   txHashIndex: null,
          //   txHash: null,
          //   tx: null,
          //   txReceipt: null,
          //   timestamp: null,
          //   exchangeRate: null,
          //   txFee: null,
          //   txFeeInReportingCurrency: null,
          // },
          approvalsSortOptions: [
            { value: 'symbolasc', text: 'â–² Symbol' },
            { value: 'symboldsc', text: 'â–¼ Symbol' },
          ],
          eventsSortOptions: [
            { value: 'txorderasc', text: 'â–² TxOrder' },
            { value: 'txorderdsc', text: 'â–¼ TxOrder' },
          ],
          pageSizes: [
            { value: 5, text: '5' },
            { value: 10, text: '10' },
            { value: 25, text: '25' },
            { value: 50, text: '50' },
            { value: 100, text: '100' },
            { value: 500, text: '500' },
            { value: 1000, text: '1k' },
            { value: 2500, text: '2.5k' },
            { value: 10000, text: '10k' },
          ],
          falseTrueOptions: [
            { value: false, text: 'false' },
            { value: true, text: 'true' },
          ],
          approvalsFields: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'type', label: 'Type', sortable: false, thStyle: 'width: 5%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'symbol', label: 'Symbol', sortable: false, thStyle: 'width: 10%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'name', label: 'Name', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'approvalType', label: 'Approval Type', sortable: false, thStyle: 'width: 10%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'owner', label: 'Owner', sortable: false, thStyle: 'width: 15%;', thClass: 'text-left', tdClass: 'text-truncate' },
            { key: 'spender', label: 'Spender', sortable: false, thStyle: 'width: 15%;', thClass: 'text-left', tdClass: 'text-truncate' },
            { key: 'approved', label: 'Approved', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
          ],
          eventsFields: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'timestamp', label: 'When', sortable: false, thStyle: 'width: 10%;', tdClass: 'text-truncate' },
            { key: 'owner', label: 'Owner', sortable: false, thStyle: 'width: 15%;', thClass: 'text-left', tdClass: 'text-truncate' },
            { key: 'type', label: 'Type', sortable: false, thStyle: 'width: 5%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'contract', label: 'Contract', sortable: false, thStyle: 'width: 15%;', thClass: 'text-left', tdClass: 'text-truncate' },
            { key: 'eventName', label: 'Event', sortable: false, thStyle: 'width: 10%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'spender', label: 'Spender', sortable: false, thStyle: 'width: 15%;', thClass: 'text-left', tdClass: 'text-truncate' },
            { key: 'approved', label: 'Approved', /*sortable: true,*/ thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
          ],
          functionCallParametersFields: [
            { key: 'parameter', label: 'Parameter', sortable: false, thStyle: 'width: 40%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'type', label: 'Type', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'value', label: 'Value', sortable: false, thStyle: 'width: 50%;', thClass: 'text-left', tdClass: 'text-left' },
          ],
          eventLogFields: [
            { key: 'logIndex', label: 'Log Index', sortable: false, thStyle: 'width: 10%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'contract', label: 'Contract', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'truncate' },
            { key: 'name', label: 'Name', sortable: false, thStyle: 'width: 20%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'fields', label: 'Fields', sortable: false, thStyle: 'width: 50%;', thClass: 'text-left', tdClass: 'text-left' },
          ],
          reportingDateTimeOptions: [
            { value: 0, text: 'Local Time' },
            { value: 1, text: 'UTC Time' },
          ],
        },

        // --- COMPUTED ---
        computed: {
          approvals() {
            const results = [];
            for (const [address, accountData] of Object.entries(this.accounts)) {
              const [contract, type, symbol, name, source, owner] = [address, accountData.type, accountData.symbol, accountData.name, accountData.source, this.coinbase];
              const approvals = 'approvals' in accountData && this.coinbase in accountData.approvals && accountData.approvals[this.coinbase] || null;
              if (approvals) {
                if (type == "erc721") {
                  for (const [value, spender] of Object.entries(approvals)) {
                    results.push({ contract, type, approvalType: "Approval", symbol, name, source, owner, spender, value });
                  }
                } else if (type == "erc20") {
                  for (const [spender, value] of Object.entries(approvals)) {
                    results.push({ contract, type, approvalType: "Approval", symbol, name, source, owner, spender, value, decimals: accountData.decimals });
                  }
                }
              }
              const approvalsForAll = 'approvalsForAll' in accountData && this.coinbase in accountData.approvalsForAll && accountData.approvalsForAll[this.coinbase] || null;
              if (approvalsForAll) {
                for (const [spender, value] of Object.entries(approvalsForAll)) {
                  results.push({ contract, type, approvalType: "ApprovalForAll", symbol, name, source, owner, spender, value });
                }
              }
            }
            return results;
          },
          filteredApprovals() {
            let results = [];
            for (const approval of this.approvals) {
              let include = true;
              if (!this.settings.approvalsTable.includeInactive) {
                if (approval.type == "erc20") {
                  if (approval.value.toString() == "0") {
                    include = false;
                  }
                } else if (approval.type == "erc721" && approval.approvalType == "Approval") {
                  if (approval.spender == ADDRESS0) {
                    include = false;
                  }
                } else {
                  if (approval.value.toString() == "0") {
                    include = false;
                  }
                }
              }
              if (include) {
                results.push(approval);
              }
            }
            return results;
          },
          filteredSortedApprovals() {
            let results = this.filteredApprovals;
            if (this.settings.eventsTable.sortOption == 'symbolasc') {
              // results.sort((a, b) => {
              //   if (a.blockNumber == b.blockNumber) {
              //     if (a.txIndex == b.txIndex) {
              //       return a.logIndex - b.logIndex;
              //     } else {
              //       return a.txIndex - b.txIndex;
              //     }
              //   } else {
              //     return a.blockNumber - b.blockNumber;
              //   }
              // });
            } else if (this.settings.eventsTable.sortOption == 'symboldsc') {
              // results.sort((a, b) => {
              //   if (a.blockNumber == b.blockNumber) {
              //     if (a.txIndex == b.txIndex) {
              //       return b.logIndex - a.logIndex;
              //     } else {
              //       return b.txIndex - a.txIndex;
              //     }
              //   } else {
              //     return b.blockNumber - a.blockNumber;
              //   }
              // });
            }
            return results;
          },
          pagedFilteredSortedApprovals() {
            console.log(moment().format("HH:mm:ss") + " pagedFilteredSortedApprovals - results[0..9]: " + JSON.stringify(this.filteredSortedApprovals.slice(0, 10), null, 2));
            return this.filteredSortedApprovals.slice((this.settings.approvalsTable.currentPage - 1) * this.settings.approvalsTable.pageSize, this.settings.approvalsTable.currentPage * this.settings.approvalsTable.pageSize);
          },

          filteredEvents() {
            const results = [];
            for (const event of this.events) {
              let include = true;
              const contractType = this.accounts[event.contract] && this.accounts[event.contract].type || null;
              const decimals = contractType == "erc20" ? this.accounts[event.contract].decimals : undefined;
              if (!this.settings.includeFluff) {
                // console.log("contractType: " + contractType);
                if (contractType == "erc721" && event.spender == ADDRESS0) {
                  include = false;
                }
              }
              if (include) {
                const timestamp = this.blockTimestamps[event.blockNumber] || "(unknown)";
                results.push({ ...event, type: contractType, decimals, timestamp });
              }
            }
            return results;
          },
          filteredSortedEvents() {
            let results = this.filteredEvents;
            if (this.settings.eventsTable.sortOption == 'txorderasc') {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  if (a.txIndex == b.txIndex) {
                    return a.logIndex - b.logIndex;
                  } else {
                    return a.txIndex - b.txIndex;
                  }
                } else {
                  return a.blockNumber - b.blockNumber;
                }
              });
            } else if (this.settings.eventsTable.sortOption == 'txorderdsc') {
              results.sort((a, b) => {
                if (a.blockNumber == b.blockNumber) {
                  if (a.txIndex == b.txIndex) {
                    return b.logIndex - a.logIndex;
                  } else {
                    return b.txIndex - a.txIndex;
                  }
                } else {
                  return b.blockNumber - a.blockNumber;
                }
              });
            }
            return results;
          },
          pagedFilteredSortedEvents() {
            // console.log(moment().format("HH:mm:ss") + " pagedFilteredSortedEvents - results[0..9]: " + JSON.stringify(this.filteredSortedEvents.slice(0, 10), null, 2));
            return this.filteredSortedEvents.slice((this.settings.eventsTable.currentPage - 1) * this.settings.eventsTable.pageSize, this.settings.eventsTable.currentPage * this.settings.eventsTable.pageSize);
          },

        },

        // --- METHODS ---
        methods: {
          approvalsRowSelected(item) {
            console.log(moment().format("HH:mm:ss") + " approvalsRowSelected: " + JSON.stringify(item));
            if (item && item.length > 0) {
              this.modalApproval.item = item[0];
              this.$bvModal.show('modal-approval');
              this.$refs.approvalsTable.clearSelected();
            }
          },

          async updateApproval() {
            console.log(moment().format("HH:mm:ss") + " updateApproval: " + JSON.stringify(this.modalApproval));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            if (this.modalApproval.item.type == 'erc20') {
              const contract = new ethers.Contract(this.modalApproval.item.contract, ERC20ABI, provider);
              const contractWithSigner = contract.connect(provider.getSigner());
              try {
                const tx = await contractWithSigner.approve(this.modalApproval.item.spender, ethers.utils.parseUnits(this.modalApproval.tokens, this.modalApproval.item.decimals));
                console.log("tx: " + JSON.stringify(tx));
              } catch (e) {
                console.log("updateApproval ERC-20.approve(...) error: " + JSON.stringify(e));
              }
            } else if (this.modalApproval.item.type == 'erc721' && this.modalApproval.item.approvalType == 'Approval') {
              const contract = new ethers.Contract(this.modalApproval.item.contract, ERC721ABI, provider);
              const contractWithSigner = contract.connect(provider.getSigner());
              try {
                const tx = await contractWithSigner.approve(this.modalApproval.spender, this.modalApproval.tokenId);
                console.log("tx: " + JSON.stringify(tx));
              } catch (e) {
                console.log("updateApproval ERC-721 approve(...) error: " + JSON.stringify(e));
              }
            } else if (this.modalApproval.item.type == 'erc721' && this.modalApproval.item.approvalType == 'ApprovalForAll') {
              const contract = new ethers.Contract(this.modalApproval.item.contract, ERC721ABI, provider);
              const contractWithSigner = contract.connect(provider.getSigner());
              try {
                const tx = await contractWithSigner.setApprovalForAll(this.modalApproval.item.spender, this.modalApproval.approved);
                console.log("tx: " + JSON.stringify(tx));
              } catch (e) {
                console.log("updateApproval ERC-721 setApprovalForAll(...) error: " + JSON.stringify(e));
              }
            } else if (this.modalApproval.item.type == 'erc1155' && this.modalApproval.item.approvalType == 'ApprovalForAll') {
              const contract = new ethers.Contract(this.modalApproval.item.contract, ERC1155ABI, provider);
              const contractWithSigner = contract.connect(provider.getSigner());
              try {
                const tx = await contractWithSigner.setApprovalForAll(this.modalApproval.item.spender, this.modalApproval.approved);
                console.log("tx: " + JSON.stringify(tx));
              } catch (e) {
                console.log("updateApproval ERC-1155 setApprovalForAll(...) error: " + JSON.stringify(e));
              }
            }
          },

          // async showModalTx(txHashIndex) {
          //   const provider = new ethers.providers.Web3Provider(window.ethereum);
          //   this.modalTx = await getTxInfo({ txHashIndex, txHash: this.indexToTxHash[txHashIndex] }, provider, this.exchangeRates);
          //   this.$bvModal.show('modal-tx');
          //   // console.log(moment().format("HH:mm:ss") + " showModalTx: " + txHashIndex + " => " + JSON.stringify(this.modalTx, null, 2));
          // },

          async checkIt(devMode) {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            this.coinbase = await signer.getAddress();
            localStorage.approvalToolCoinbase = this.coinbase;
            const network = await provider.getNetwork();
            localStorage.approvalToolChainId = network.chainId;
            const block = await provider.getBlock();
            const latestBlockNumber = block && block.number || null;
            console.log(moment().format("HH:mm:ss") + " checkIt - latestBlockNumber: " + latestBlockNumber + ", chainId: " + this.chainId);

            if (!devMode) {
              await this.syncApprovalEvents(provider, latestBlockNumber);
            }
            if (!devMode) {
              await this.syncNames(provider);
            }
            if (!devMode) {
              await this.syncBlockTimestamps();
            }
            // if (devMode) {
              await this.processData(provider);
            // }
            this.sync.section = null;
            this.sync.halt = false;
          },

          async syncApprovalEvents(provider, latestBlockNumber) {
            // ERC-20 Approval (index_topic_1 address owner, index_topic_2 address spender, uint256 value)
            // 0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925
            // ERC-721 Approval (index_topic_1 address owner, index_topic_2 address approved, index_topic_3 uint256 tokenId)
            // 0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925
            // ERC-721 ApprovalForAll (index_topic_1 address owner, index_topic_2 address operator, bool approved)
            // 0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31
            // ERC-1155 ApprovalForAll (index_topic_1 address account, index_topic_2 address operator, bool approved)
            // 0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31
            const accounts = [this.coinbase];
            const accountsAs32Bytes = accounts.map(e => '0x000000000000000000000000' + e.substring(2, 42).toLowerCase());
            const approvalLogs = await provider.getLogs({
              address: null,
              fromBlock: 0,
              toBlock: latestBlockNumber,
              topics: [[
                  '0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925',
                  '0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31'
                ],
                accountsAs32Bytes,
                null
              ],
            });
            const events = [];
            for (const log of approvalLogs) {
              const topic0 = log.topics[0];
              const eventName = topic0 == '0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31' ? 'ApprovalForAll': 'Approval';
              let owner = null;
              let spender = null;
              let value = null;
              if (log.topics.length == 3) {
                owner = ethers.utils.getAddress('0x' + log.topics[1].substring(26));
                spender = ethers.utils.getAddress('0x' + log.topics[2].substring(26));
                value = ethers.BigNumber.from(log.data).toString();
              } else if (log.topics.length == 4) {
                owner = ethers.utils.getAddress('0x' + log.topics[1].substring(26));
                spender = ethers.utils.getAddress('0x' + log.topics[2].substring(26));
                value = ethers.BigNumber.from(log.topics[3]).toString();
              } else {
                console.log("topic length <> 4: " + log.topics.length + " " + JSON.stringify(log));
              }
              if (owner) {
                events.push({ blockNumber: log.blockNumber, txIndex: log.transactionIndex, txHash: log.transactionHash,
                  logIndex: log.logIndex, contract: log.address, eventName, owner, spender, value });
              }
            }
            localStorage.approvalEvents = JSON.stringify(events);
            Vue.set(this, 'events', events);
          },

          async syncNames(provider) {
            const ownersMap = {};
            const contractsMap = {};
            const spendersMap = {};
            for (const event of this.events) {
              if (!(event.owner in ownersMap)) {
                ownersMap[event.owner] = true;
              }
              if (!(event.contract in contractsMap)) {
                contractsMap[event.contract] = true;
              }
              if (!(event.spender in spendersMap)) {
                spendersMap[event.spender] = true;
              }
            }
            const owners = Object.keys(ownersMap);
            const contracts = Object.keys(contractsMap);
            const spenders = Object.keys(spendersMap);
            const accounts = {};
            for (const account of owners) {
              accounts[account] = { source: "owner" };
            }
            for (const account of contracts) {
              if (!(account in accounts)) {
                accounts[account] = { source: "contracts" };
              }
            }
            for (const account of spenders) {
              if (!(account in accounts)) {
                accounts[account] = { source: "spenders" };
              }
            }
            const erc721Helper = new ethers.Contract(ERC721HELPERADDRESS, ERC721HELPERABI, provider);
            const accountsToCheck = [...owners, ...contracts, ...spenders];
            for (const account of accountsToCheck) {
              if (account in CUSTOMNAMES) {
                accounts[account].type = CUSTOMNAMES[account][0];
                accounts[account].symbol = CUSTOMNAMES[account][1];
                accounts[account].name = CUSTOMNAMES[account][2];
                accounts[account].decimals = CUSTOMNAMES[account].length >= 4 ? CUSTOMNAMES[account][3] : undefined;
              } else {
                try {
                  const tokenInfos = await erc721Helper.tokenInfo([account], { gasLimit: 1000000 });
                  for (let i = 0; i < tokenInfos[0].length; i++) {
                    const mask = tokenInfos[0][i].toNumber();
                    const symbol = tokenInfos[1][i];
                    const name = tokenInfos[2][i];
                    if ((mask & MASK_ISEOA) == MASK_ISERC721) {
                      accounts[account].type = "eoa";
                    } else if ((mask & MASK_ISERC20) == MASK_ISERC20) {
                      accounts[account].type = "erc20";
                      accounts[account].symbol = symbol;
                      accounts[account].name = name;
                      const erc20Contract = new ethers.Contract(account, ERC20ABI, provider);
                      try {
                        accounts[account].decimals = await erc20Contract.decimals();
                      } catch (e1) {
                        accounts[account].decimals = 0;
                      }
                    } else if ((mask & MASK_ISERC721) == MASK_ISERC721) {
                      accounts[account].type = "erc721";
                      accounts[account].symbol = symbol;
                      accounts[account].name = name;
                    } else {
                      const erc165Abi = [ "function supportsInterface(bytes4 interfaceID) external view returns (bool)" ];
                      const erc165Contract = new ethers.Contract(account, erc165Abi, provider);
                      try {
                        const result = await erc165Contract.supportsInterface(ERC1155_INTERFACE);
                        console.log(account + " " + result);
                        if (result) {
                          accounts[account].type = "erc1155";
                        } else {
                          accounts[account].type = "unknown2";
                        }
                      } catch (e1) {
                        accounts[account].type = "unknown1";
                      }
                      // console.log("  " + account + " " + symbol + " " + name + " " + mask);
                    }
                  }
                } catch (e) {
                  console.log("syncNames erc721Helper - ERROR: " + account + ", message: " + e.message);
                  accounts[account].type = "unknown0";
                }
              }
            }
            localStorage.approvalAccounts = JSON.stringify(accounts);
            Vue.set(this, 'accounts', accounts);
          },

          // // TODO: Refresh sync
          // async syncENSNames(newAddressIndexes, provider) {
          //   const ensReverseRecordsContract = new ethers.Contract(ENSREVERSERECORDSADDRESS, ENSREVERSERECORDSABI, provider);
          //   let indexToAddress = [];
          //   let addressToIndex = {};
          //   const indexToAddressDataItems = await db.cache.where("objectName").equals(this.chainId + "_indexToAddress").toArray();
          //   if (indexToAddressDataItems.length == 1) {
          //     indexToAddress = indexToAddressDataItems[0].object;
          //     for (const [index, address] of indexToAddress.entries()) {
          //       addressToIndex[address] = index;
          //     }
          //   }
          //   const addresses = newAddressIndexes.map(e => indexToAddress[e]);
          //   this.sync.completed = 0;
          //   this.sync.total = addresses.length;
          //   this.sync.section = 'ENS Names';
          //   const MAXBATCHSIZE = 1000;
          //   let batchSize = MAXBATCHSIZE;
          //   let completed = 0;
          //   let done = false;
          //   let start = completed;
          //   do {
          //     let end = parseInt(start) + batchSize - 1;
          //     if (end > addresses.length) {
          //       end = addresses.length;
          //     }
          //     try {
          //       const batch = addresses.slice(start, end + 1);
          //       const allnames = await ensReverseRecordsContract.getNames(batch);
          //       for (let j = 0; j < batch.length; j++) {
          //         const account = batch[j];
          //         const name = allnames[j];
          //         // TODO: const normalized = normalize(account);
          //         if (name.length > 0) {
          //           // console.log(account + " => " + name);
          //           Vue.set(this.indexToAddressName, addressToIndex[account], name);
          //         }
          //       }
          //       start = parseInt(end) + 1;
          //     } catch (e) {
          //       if (batchSize > 1) {
          //         batchSize = parseInt(batchSize / 2);
          //       } else {
          //         console.log("Skipping #" + start + " " + addresses[start]);
          //         start = parseInt(start) + 1;
          //         batchSize = MAXBATCHSIZE;
          //       }
          //     }
          //     this.sync.completed = start;
          //     done = start > addresses.length;
          //   } while (!done);
          //
          //   for (const [address, name] of Object.entries(CUSTOMNAMES)) {
          //     Vue.set(this.indexToAddressName, addressToIndex[address], name);
          //   }
          //   // console.log("this.indexToAddressName: " + JSON.stringify(this.indexToAddressName, null, 2));
          //   await db.cache.put({ objectName: CHAINID_MAINNET + "_indexToAddressName", object: this.indexToAddressName }).then (function() {
          //   }).catch(function(error) {
          //     console.log("error: " + error);
          //   });
          //   console.log(moment().format("HH:mm:ss") + " syncENSNames END");
          // },

          async syncBlockTimestamps() {
            console.log(moment().format("HH:mm:ss") + " syncBlockTimestamps");
            const blockNumbersMap = {};
            for (const event of this.events) {
              if (!(event.blockNumber in blockNumbersMap)) {
                blockNumbersMap[event.blockNumber] = true;
              }
            }
            const blockNumbers = Object.keys(blockNumbersMap);
            this.sync.completed = 0;
            this.sync.total = blockNumbers.length;
            this.sync.section = 'Block Timestamps';
            const BATCHSIZE = 1000;
            const blockTimestamps = {};
            for (let i = 0; i < blockNumbers.length; i += BATCHSIZE) {
              const batch = blockNumbers.slice(i, parseInt(i) + BATCHSIZE);
              const data = await fetch(BLOCKTIMESTAMPSUBGRAPHURL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json',
                },
                body: JSON.stringify({
                  query: BLOCKTIMESTAMPINQUERY,
                  variables: { blockNumbers: batch.map(e => parseInt(e)) },
                })
              }).then(response => response.json())
              .catch(function(e) {
                console.log("error: " + e);
              });
              const timestamps = data.data && data.data.blocks || [];
              for (const timestampItem of timestamps) {
                blockTimestamps[timestampItem.number] = parseInt(timestampItem.timestamp);
              }
              this.sync.completed += timestamps.length;
              console.log(moment().format("HH:mm:ss") + " syncBlockTimestamps " + this.sync.completed + " of " + blockNumbers.length);
            }
            localStorage.approvalBlockTimestamps = JSON.stringify(blockTimestamps);
            Vue.set(this, 'blockTimestamps', blockTimestamps);
          },

          async processData(provider) {
            console.log(moment().format("HH:mm:ss") + " processData BEGIN");
            const accounts = this.accounts;
            for (const [eventIndex, event] of this.events.entries()) {
              console.log(event.blockNumber + "." + event.txIndex + "." + event.logIndex);
              const contract = event.contract;
              const account = accounts[contract];
              if (account.type == "erc20") {
                if (!('approvals' in account)) {
                  account.approvals = {};
                }
                if (!(event.owner in account.approvals)) {
                  account.approvals[event.owner] = {};
                }
                // Get current ERC-20 allowance as this amount is reduced by `transferFrom(...)` calls
                // account.approvals[event.owner][event.spender] = event.value;
                const erc20Contract = new ethers.Contract(contract, ERC20ABI, provider);
                const newValue = await erc20Contract.allowance(event.owner, event.spender);
                account.approvals[event.owner][event.spender] = newValue.toString();
              } else if (account.type == "erc721") {
                if (event.eventName == "Approval") {
                  if (!('approvals' in account)) {
                    account.approvals = {};
                  }
                  if (!(event.owner in account.approvals)) {
                    account.approvals[event.owner] = {};
                  }
                  account.approvals[event.owner][event.value] = event.spender;
                } else if (event.eventName == "ApprovalForAll") {
                  if (!('approvalsForAll' in account)) {
                    account.approvalsForAll = {};
                  }
                  if (!(event.owner in account.approvalsForAll)) {
                    account.approvalsForAll[event.owner] = {};
                  }
                  account.approvalsForAll[event.owner][event.spender] = event.value;
                }
              } else if (account.type == "erc1155") {
                if (!('approvalsForAll' in account)) {
                  account.approvalsForAll = {};
                }
                if (!(event.owner in account.approvalsForAll)) {
                  account.approvalsForAll[event.owner] = {};
                }
                account.approvalsForAll[event.owner][event.spender] = event.value;
              }
              Vue.set(this.accounts, contract, account);
            }
            console.log("accounts: " + JSON.stringify(accounts, null, 2));
            localStorage.approvalAccounts = JSON.stringify(accounts);
            // Vue.set(this, 'accounts', accounts);
            // TODO: UI not updating
          },

          saveSettings() {
            localStorage.approvalToolSettings = JSON.stringify(this.settings);
          },
          async processNewBlock(blockNumber) {
            console.log(moment().format("HH:mm:ss") + " processNewBlock #" + this.commify0(blockNumber) + ", latest #" + this.commify0(this.blockNumber) + " @ " + moment.unix(this.timestamp).format("YYYY-MM-DD HH:mm:ss") + " " + moment.unix(this.timestamp).fromNow());
          },
          async halt() {
            this.sync.halt = true;
            console.log(moment().format("HH:mm:ss") + " halt()");
          },
          commify0(n) {
            if (n != null) {
              return Number(n).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return null;
          },
          commify2(n) {
            if (n != null) {
              return Number(parseFloat(n).toFixed(2)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return null;
          },
          formatETH(e, precision = 9) {
            try {
              if (precision == 0) {
                return e ? ethers.utils.formatEther(e) : null;
              } else {
                return e ? parseFloat(ethers.utils.formatEther(e)).toFixed(precision) : null;
              }
            } catch (err) {
            }
            return e.toFixed(precision);
          },
          formatDecimals(e, decimals = 18) {
            return e ? ethers.utils.formatUnits(e, decimals) : null;
          },
          formatGas(e, precision = 9) {
            try {
              if (precision == 0) {
                return e ? ethers.utils.formatUnits(e, "gwei") : null;
              } else {
                return e ? parseFloat(ethers.utils.formatUnits(e, "gwei")).toFixed(precision) : null;
              }
            } catch (err) {
            }
            return e.toFixed(precision);
          },
          formatTimestamp(ts) {
            if (ts != null) {
              if (this.settings.reportingDateTime == 1) {
                return moment.unix(ts).utc().format("YYYY-MM-DD HH:mm:ss");
              } else {
                return moment.unix(ts).format("YYYY-MM-DD HH:mm:ss");
              }
            }
            return null;
          },
          formatTimeDiff(unixtime) {
            if (!unixtime) {
              return "";
            } else {
              return moment.unix(unixtime).fromNow();
            }
          },
          nameOrAddress(addressOrAddressIndex, length = 0) {
            let result = null;
            if (new RegExp('^[0-9,]+$').test(addressOrAddressIndex)) {
              if (addressOrAddressIndex in this.accounts) {
                result = this.accounts[addressOrAddressIndex] && this.accounts[addressOrAddressIndex].symbol || "error";
              } else {
                result = this.indexToAddress[addressOrAddressIndex];
              }
            } else {
              if (addressOrAddressIndex in this.accounts) {
                result = this.accounts[addressOrAddressIndex].name || addressOrAddressIndex;
              } else {
                result = addressOrAddressIndex;
              }
            }
            if (result && length > 0) {
              result = result.substring(0, length);
            }
            return result;
          },
          addressDescription(address) {
            if (address in this.accounts) {
              result = "type=" + this.accounts[address].type + "; symbol=" + this.accounts[address].symbol + "; name=" + this.accounts[address].name;
              if (this.accounts[address].decimals) {
                result = result + "; decimals=" + this.accounts[address].decimals;
              }
              result = result + "; source=" + this.accounts[address].source + "; address=" + address;
            } else {
              result = address;
            }
            return result;
          },
          // exportAccounts() {
          //   console.log("exportAccounts");
          //   const rows = [
          //       ["No", "Address", "Name", "ENSName", "Group", "Sync", "Include"],
          //   ];
          //   let i = 1;
          //   for (const result of this.filteredSortedAccounts) {
          //     rows.push([
          //       i,
          //       result.address,
          //       result.name,
          //       result.ensName,
          //       result.group,
          //       result.sync ? "y" : "n",
          //       result.include ? "y" : "n",
          //     ]);
          //     i++;
          //   }
          //   let tsvContent = "data:text/tsv;charset=utf-8," + rows.map(e => e.join("\t")).join("\n");
          //   var encodedUri = encodeURI(tsvContent);
          //   var link = document.createElement("a");
          //   link.setAttribute("href", encodedUri);
          //   link.setAttribute("download", "mynfts_account_export-" + moment().format("YYYY-MM-DD-HH-mm-ss") + ".tsv");
          //   document.body.appendChild(link); // Required for FF
          //   link.click(); // This will download the data with the specified file name
          // },
          copyToClipboard(str) {
            navigator.clipboard.writeText(str);
          },
          async connectToWeb3() {
            console.log(moment().format("HH:mm:ss") + " connectToWeb3");
            if (!window.ethereum) {
              this.connected = false;
            } else {
              try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.connected = window.ethereum.isConnected();
              } catch (e) {
                console.log("window.ethereum.request error: " + e.message);
                this.connected = false;
              }
            }
            // console.log(moment().format("HH:mm:ss") + " connectToWeb3 - connected: " + this.connected);
            if (!this.connected) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, for web3 data retrieval. And refresh!");
            } else {
              const t = this;
              // console.log(moment().format("HH:mm:ss") + " connectToWeb3 - installing listeners");
              function handleChainChanged(_chainId) {
                t.chainId = _chainId;
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleChainChanged - this.chainId: " + t.chainId);
                alert('Ethereum chain has changed - reloading this page.')
                window.location.reload();
              }
              window.ethereum.on('chainChanged', handleChainChanged);
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              async function handleAccountsChanged(accounts) {
                const signer = provider.getSigner();
                t.coinbase = await signer.getAddress();
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleAccountsChanged: " + t.coinbase);
              }
              window.ethereum.on('accountsChanged', handleAccountsChanged);
              async function handleNewBlock(blockNumber) {
                if (!t.blockNumber || blockNumber > t.blockNumber) {
                  const block = await provider.getBlock("latest");
                  t.blockNumber = block.number;
                  t.timestamp = block.timestamp;
                  await t.processNewBlock(blockNumber);
                }
              }
              provider.on("block", handleNewBlock);
              const signer = provider.getSigner();
              this.coinbase = await signer.getAddress();
              const network = await provider.getNetwork();
              this.chainId = network.chainId;
              // console.log(moment().format("HH:mm:ss") + " connectToWeb3 - chainId: " + this.chainId);
            }
          },
        },

        // --- MOUNTED ---
        mounted() {
          (async() => {
            await this.connectToWeb3();
          })();
          if ('approvalToolChainId' in localStorage) {
            this.chainId = localStorage.approvalToolChainId;
          }
          if ('approvalToolCoinbase' in localStorage) {
            this.coinbase = localStorage.approvalToolCoinbase;
          }
          if ('approvalToolSettings' in localStorage) {
            const tempSettings = JSON.parse(localStorage.approvalToolSettings);
            if ('version' in tempSettings && tempSettings.version == this.settings.version) {
              this.settings = tempSettings;
              if (this.settings.approvalsTable.currentPage > 1) {
                this.settings.approvalsTable.currentPage = 1;
              }
              if (this.settings.eventsTable.currentPage > 1) {
                this.settings.eventsTable.currentPage = 1;
              }
            }
          }
          if ('approvalEvents' in localStorage) {
            const tempEvents = JSON.parse(localStorage.approvalEvents);
            this.events = tempEvents;
          }
          if ('approvalAccounts' in localStorage) {
            const tempAccounts = JSON.parse(localStorage.approvalAccounts);
            this.accounts = tempAccounts;
          }
          if ('approvalBlockTimestamps' in localStorage) {
            const tempBlockTimestamps = JSON.parse(localStorage.approvalBlockTimestamps);
            this.blockTimestamps = tempBlockTimestamps;
          }
        },
      })
    </script>
  </body>
</html>
